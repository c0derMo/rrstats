<script>
    let pageData = {};
    let changes = {};

    $('#save').on("click", () => {
        $('#amountChanges').text(Object.keys(changes).length);
        $('#listedChanges').html("")
        Object.keys(changes).forEach(k => {
            $('#listedChanges').append("<div class='item'>" + k + ": " + changes[k] + "</div>");
        });
        $('#saveConfirmModal').modal('show');
    });

    $('#saveConfirm').on("click", () => {
        $.ajax("/backend/api/competition", {
            data: changes,
            method: 'PATCH',
            success: (data, status, x) => {
                if(data.success === true) {
                    $('body').toast({
                        message: 'Changes sent to the database.'
                    })
                    changes = {};
                } else {
                    $('body').toast({
                        message: 'An error occured when sending changes to the database!',
                        class: 'failure'
                    })
                }
            },
            error: (data, status, x) => {
                $('body').toast({
                    message: 'An error occured when sending changes to the database: ' + status,
                    class: 'failure'
                });
            }
        });
    });

    $('.ui.accordion').accordion();

    $('#competition').on("change", (e) => {
        $.get("/backend/api/competition", {competition: $('#competition').val()}, (data, status, x) => {
            if(status === "success") {
                pageData = {};
                changes = {};

                $("#table").html("")
                data.forEach((element) => {
                    pageData[element._id] = element;
                    addMatch(element);
                });

                // Add listeners
                $('input[type="text"]').on("change", inputChanged);
                $('.score').on("change", inputChanged);
                $('.map').on("change", inputChanged);
                $('.selectWinPick').on("change", selectChanged);
            }
        });
    });

    function getJSONPath(obj, path) {
        let split = path.split(".").reverse();
        let response = obj;
        while(split.length > 0) {
            response = response[split.pop()];
        }
        return response;
    }

    function inputChanged(e) {
        let matchId = $(e.target).attr("id");
        let path = $(e.target).attr("attr");

        if($(e.target).val() === getJSONPath(pageData[matchId], path)) {
            delete changes[matchId + ";" + path];
        } else {
            changes[matchId + ";" + path] = $(e.target).val();
        }
    }

    function selectChanged(e) {
        let matchId = $(e.target).attr("id");
        let path = $(e.target).attr("attr");

        if(parseInt($(e.target).val()) === getJSONPath(pageData[matchId], path)) {
            delete changes[matchId + ";" + path];
        } else {
            changes[matchId + ";" + path] = parseInt($(e.target).val());
        }
    }

    function addMatch(match) {
        let amountRows = Math.max(Math.ceil(match.maps.length / 3), 1);

        let rows = [];
        for (let index = 0; index < amountRows; index++) {
            rows.push($('<tr></tr>'));
        }
        rows[0].append($("<td></td>").attr("rowspan", amountRows).append($("<input type='text' value='" + match.platform + "'>").attr("id", match._id).attr("attr", "platform")));
        rows[0].append($("<td></td>").attr("rowspan", amountRows).append($("<input type='text' value='" + match.round + "'>").attr("id", match._id).attr("attr", "platform")));

        let winnerSelectRow = $('<select class="selectWinPick" id="' + match._id + '" attr="score.winner"></select>');
        if(match.score.winner === 1) {
            winnerSelectRow.append("<option value='1' selected>1 (" + match.player1 + ")</option>");
            winnerSelectRow.append("<option value='2'>2 (" + match.player2 + ")</option>");
            winnerSelectRow.append("<option value='0'>0 (Draw)</option>");
        } else if(match.score.winner === 2) {
            winnerSelectRow.append("<option value='1'>1 (" + match.player1 + ")</option>");
            winnerSelectRow.append("<option value='2' selected>2 (" + match.player2 + ")</option>");
            winnerSelectRow.append("<option value='0'>0 (Draw)</option>");
        } else {
            winnerSelectRow.append("<option value='1'>1 (" + match.player1 + ")</option>");
            winnerSelectRow.append("<option value='2'>2 (" + match.player2 + ")</option>");
            winnerSelectRow.append("<option value='0' selected>0 (Draw)</option>");
        }
        rows[0].append($("<td></td>").attr("rowspan", amountRows).append(winnerSelectRow));

        rows[0].append($("<td><input type='text' value='" + match.player1 + "' id='" + match._id + "' attr='player1'></td>").attr("rowspan", amountRows));
        rows[0].append($("<td><input class='score' type='text' value='" + match.score.player1Points + "' id='" + match._id + "' attr='score.player1Points'></td>").attr("rowspan", amountRows));
        rows[0].append($('<td>-</td>').attr('rowspan', amountRows));
        rows[0].append($("<td><input class='score' type='text' value='" + match.score.player2Points + "' id='" + match._id + "' attr='score.player2Points'></td>").attr("rowspan", amountRows));
        rows[0].append($("<td><input type='text' value='" + match.player2 + "' id='" + match._id + "' attr='player2'></td>").attr("rowspan", amountRows));

        match.maps.forEach((m, midx) => {
            let row = Math.floor(midx / 3);
            rows[row].append("<td><input class='map' type='text' value='" + m.map + "' id='" + match._id + "' attr='maps." + midx + ".map'></td>");

            let winnerSelectMap = $("<select class='selectWinPick'></select>").attr("id", match._id + "' attr='maps." + midx + ".winner");
            switch(m.winner) {
                case 0:
                    winnerSelectMap.append("<option value='1'>1 (" + match.player1 + ")</option>");
                    winnerSelectMap.append("<option value='2'>2 (" + match.player2 + ")</option>");
                    winnerSelectMap.append("<option value='0' selected>0 (Tie)</option>");
                    break;
                case 1:
                    winnerSelectMap.append("<option value='1' selected>1 (" + match.player1 + ")</option>");
                    winnerSelectMap.append("<option value='2'>2 (" + match.player2 + ")</option>");
                    winnerSelectMap.append("<option value='0'>0 (Tie)</option>");
                    break;
                case 2:
                    winnerSelectMap.append("<option value='1'>1 (" + match.player1 + ")</option>");
                    winnerSelectMap.append("<option value='2' selected>2 (" + match.player2 + ")</option>");
                    winnerSelectMap.append("<option value='0'>0 (Tie)</option>");
                    break;
                default:
                    winnerSelectMap.append("<option value='1'>1 (" + match.player1 + ")</option>");
                    winnerSelectMap.append("<option value='2'>2 (" + match.player2 + ")</option>");
                    winnerSelectMap.append("<option value='0' selected>0 (Tie)</option>");
                    break;
            }
            rows[row].append($("<td></td>").append(winnerSelectMap));
            
            let pickedSelectMap = $('<select class="selectWinPick"></select>').attr("id", match._id + "' attr='maps." + midx + ".picked");
            switch(m.picked) {
                case 0:
                    pickedSelectMap.append("<option value='1'>1 (" + match.player1 + ")</option>");
                    pickedSelectMap.append("<option value='2'>2 (" + match.player2 + ")</option>");
                    pickedSelectMap.append("<option value='0' selected>0 (RNG)</option>");
                    break;
                case 1:
                    pickedSelectMap.append("<option value='1' selected>1 (" + match.player1 + ")</option>");
                    pickedSelectMap.append("<option value='2'>2 (" + match.player2 + ")</option>");
                    pickedSelectMap.append("<option value='0'>0 (RNG)</option>");
                    break;
                case 2:
                    pickedSelectMap.append("<option value='1'>1 (" + match.player1 + ")</option>");
                    pickedSelectMap.append("<option value='2' selected>2 (" + match.player2 + ")</option>");
                    pickedSelectMap.append("<option value='0'>0 (RNG)</option>");
                    break;
                default:
                    pickedSelectMap.append("<option value='1'>1 (" + match.player1 + ")</option>");
                    pickedSelectMap.append("<option value='2'>2 (" + match.player2 + ")</option>");
                    pickedSelectMap.append("<option value='0' selected>0 (RNG)</option>");
                    break;
            }
            rows[row].append($("<td></td>").append(pickedSelectMap));
        })

        rows.forEach(r => {
            $('#table').append(r);
        });
    }
</script>