<!DOCTYPE html>
<html>
    <head>
        <title>RR Player Statistics</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css">
    </head>
    <body>
        <div class="ui basic modal" id="saveConfirmModal">
            <div class="ui icon header">
                <i class="save icon"></i>
                Save changes
            </div>
            <div class="content">
                <p>Are you sure that you want to push <span id="amountChanges"></span> changes to the database?</p>
                <div class="ui inverted accordion">
                    <div class="title">
                        <i class="dropdown icon"></i>
                        List all changes
                    </div>
                    <div class="content">
                        <div class="ui bulleted list" id="listedChanges">
                            
                        </div>
                    </div>
                </div>
                <div class="actions">
                    <div class="ui red basic cancel inverted button">
                        <i class="remove icon"></i>
                        No
                    </div>
                    <div class="ui green ok inverted button" id="saveConfirm">
                        <i class="checkmark icon"></i>
                        Yes
                    </div>
                </div>
            </div>
        </div>
        <div class="ui container">
            <br>
            <h1 class="ui header"><a href="/backend"><i class="small reply icon"></i></a>RR Players</h1>
            <br>
            <span style="font-style: italic;">An empty title will lead to automatic assignment of either "Roulette Rookie" or "Returning Rival", depending on the current competition</span>
            <button class="ui right floated positive button" id="save"><i class="save icon"></i>Save</button>
            <br><br>
            <table class="ui structured small celled table">
                <thead>
                    <th>Name</th>
                    <th>Title</th>
                    <th>Custom title</th>
                    <th>Discord ID</th>
                    <th>Competitions</th>
                </thead>
                <tbody id="players">
                </tbody>
            </table>
        </div>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.js"></script>
        <script>
            let pageData = {};
            let changes = {};

            $('#save').on("click", () => {
                $('#amountChanges').text(Object.keys(changes).length);
                $('#listedChanges').html("")
                Object.keys(changes).forEach(k => {
                    if(changes[k] instanceof Array) {
                        $('#listedChanges').append("<div class='item'>" + k + ": " + JSON.stringify(changes[k]) + "</div>");
                    } else {
                        $('#listedChanges').append("<div class='item'>" + k + ": " + changes[k] + "</div>");
                    }
                });
                $('#saveConfirmModal').modal('show');
            });

            $('#saveConfirm').on("click", () => {
                $.ajax("/backend/api/players", {
                    data: {
                        changes: JSON.stringify(changes)
                    },
                    method: 'PATCH',
                    success: (data, status, x) => {
                        if(data.status === "ok") {
                            $('body').toast({
                                message: 'Changes sent to the database.'
                            })
                            changes = {};
                        } else {
                            $('body').toast({
                                message: 'An error occured when sending changes to the database!',
                                class: 'failure'
                            })
                        }
                    },
                    error: (data, status, x) => {
                        $('body').toast({
                            message: 'An error occured when sending changes to the database: ' + status,
                            class: 'failure'
                        });
                    }
                });
            });

            $(document).ready(() => {
                $('.ui.accordion').accordion();
                $.get("/backend/api/players", "", (data, status, x) => {
                    if(status === "success") {
                        pageData = data;
                        Object.keys(data).forEach(e => {
                            addPlayer(e, data[e])
                        });

                        $('input').on("change", changeInput);
                        $('textarea').on("change", changeArea);
                    }
                });
            });

            function addPlayer(pName, pData) {
                let row = $('<tr></tr>');
                row.append($('<td>' + pName + '</td>'));
                row.append($('<td></td>').append($('<input type="text" value="' + pData.title + '">').attr('id', pName + ".title")));
                row.append($('<td></td>').append($('<input type="checkbox">').attr('id', pName + ".customTitle").attr("checked", pData.customTitle)));
                row.append($('<td></td>').append($('<input type="text" value="' + pData.discordId + '">').attr('id', pName + ".discordId")));
                let accordion = $('<div></div>').addClass("ui accordion");
                accordion.append($('<div></div>').addClass("title").append($("<i></i>").addClass("dropdown icon")));
                let competitionsString = ""
                pData.competitions.forEach(c => {
                    competitionsString += c.competition + ": " + c.placement + "\n";
                })
                accordion.append($('<div></div>').addClass("content").append($("<textarea></textarea>").val(competitionsString).attr('player', pName).css("width", "100%").css("height", "50px")));
                row.append($('<td></td>').append(accordion.accordion()));

                $('#players').append(row);
            }

            function getJSONPath(obj, path) {
                let split = path.split(".").reverse();
                let response = obj;
                while(split.length > 0) {
                    response = response[split.pop()];
                }
                return response;
            }

            function changeInput(e) {
                if($(e.target).attr("type") == "checkbox") {
                    if($(e.target).is(":checked") == getJSONPath(pageData, $(e.target).attr("id"))) {
                        delete changes[$(e.target).attr("id")]
                    } else {
                        changes[$(e.target).attr("id")] = $(e.target).is(":checked");
                    }
                } else {
                    if($(e.target).val() === getJSONPath(pageData, $(e.target).attr("id"))) {
                        delete changes[$(e.target).attr("id")]
                    } else {
                        changes[$(e.target).attr("id")] = $(e.target).val();
                    }
                }
            }

            function changeArea(e) {
                let competitionsString = ""
                pageData[$(e.target).attr("player")].competitions.forEach(c => {
                    competitionsString += c.competition + ": " + c.placement + "\n";
                });

                if($(e.target).val() === competitionsString) {
                    delete changes[$(e.target).attr("player") + ".competitions"]
                } else {
                    let comps = []
                    $(e.target).val().split("\n").forEach(c => {
                        let comp = c.split(": ");
                        if(comp.length > 1) {
                            comps.push({competition: comp[0], placement: comp[1]})
                        }
                    });
                    changes[$(e.target).attr("player") + ".competitions"] = comps;
                }
            }

        </script>
    </body>
</html>