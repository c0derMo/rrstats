<script>
    $('#save').on("click", () => {
        $.getJSON('/backend/api/players', {}, (data, status, x) => {
            if(status == "success") {
                let undefinedUsers = [];
                $('#placements').val().split("\n").forEach(e => {
                    if(data[e.split(": ")[0]] === undefined) {
                        undefinedUsers.push(e.split(": ")[0]);
                    }
                });
                if(undefinedUsers.length == 0) {
                    $('#saveConfirmModal').modal("show");
                } else {
                    $('body').toast({
                        message: 'The following users were not found: ' + undefinedUsers.join(", "),
                        class: 'error',
                        showProgress: 'top'
                    })
                }
            }
        })
    });
    
    $('#saveConfirm').on("click", () => {
        $.getJSON('/backend/api/players', {}, (data, status, x) => {
            if(status === "success") {
                let changes = {}
                let comp = $('#comp').val()
                $('#placements').val().split("\n").forEach(e => {
                    let user = e.split(": ")[0];
                    let placement = e.split(": ")[1];
                    data[user].competitions.unshift({competition: comp, placement: placement});
                    changes[user + '.competitions'] = data[user].competitions;
                });
                $.ajax('/backend/api/players', {
                    data: {
                        changes: JSON.stringify(changes)
                    },
                    method: 'PATCH',
                    success: (data, status, x) => {
                        if(data.status === "ok") {
                            $('body').toast({
                                message: 'Changes sent to the database.'
                            })
                        } else {
                            $('body').toast({
                                message: 'An error occured when sending changes to the database!',
                                class: 'failure'
                            })
                        }
                    },
                    error: (xhr, status, x) => {
                        $('body').toast({
                            message: 'An error occured when sending changes to the database: ' + status,
                            class: 'failure'
                        });
                    }
                })
            }
        });
    });
</script>