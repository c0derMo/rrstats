<script>
    let pageData = {};
    let changes = {};

    $('#save').on("click", () => {
        $('#amountChanges').text(Object.keys(changes).length);
        $('#listedChanges').html("")
        Object.keys(changes).forEach(k => {
            if(changes[k] instanceof Array) {
                $('#listedChanges').append("<div class='item'>" + k + ": " + JSON.stringify(changes[k]) + "</div>");
            } else {
                $('#listedChanges').append("<div class='item'>" + k + ": " + changes[k] + "</div>");
            }
        });
        $('#saveConfirmModal').modal('show');
    });

    $('#saveConfirm').on("click", () => {
        $.ajax("/backend/api/players", {
            data: changes,
            method: 'PATCH',
            success: (data, status, x) => {
                if(data.success === true) {
                    $('body').toast({
                        message: 'Changes sent to the database.'
                    })
                    changes = {};
                } else {
                    $('body').toast({
                        message: 'An error occured when sending changes to the database!',
                        class: 'failure'
                    })
                }
            },
            error: (data, status, x) => {
                $('body').toast({
                    message: 'An error occured when sending changes to the database: ' + status,
                    class: 'failure'
                });
            }
        });
    });

    $(document).ready(() => {
        $('.ui.accordion').accordion();
        $.get("/backend/api/players", "", (data, status, x) => {
            if(status === "success") {
                pageData = {};
                data.forEach(player => {
                    pageData[player._id] = player;
                    addPlayer(player);
                })

                $('input').on("change", changeInput);
                $('textarea').on("change", changeArea);
            }
        });
    });

    function addPlayer(player) {
        let row = $('<tr></tr>');
        row.append($('<td>' + player.primaryName + '</td>'));
        row.append($('<td></td>').append($('<input type="text" value="' + player.title + '">').attr('id', player._id).attr("attr", "title")));
        row.append($('<td></td>').append($('<input type="checkbox">').attr('id', player._id).attr("attr", "customTitle").attr("checked", player.customTitle)));
        row.append($('<td></td>').append($('<input type="text" value="' + player.discordId + '">').attr('id', player._id).attr("attr", "discordId")));
        let accordion = $('<div></div>').addClass("ui accordion");
        accordion.append($('<div></div>').addClass("title").append($("<i></i>").addClass("dropdown icon")));
        let competitionsString = ""
        player.competitions.forEach(c => {
            competitionsString += c.competition + ": " + c.placement + "\n";
        })
        accordion.append($('<div></div>').addClass("content").append($("<textarea></textarea>").val(competitionsString).attr('player', player._id).css("width", "100%").css("height", "50px")));
        row.append($('<td></td>').append(accordion.accordion()));

        $('#players').append(row);
    }

    function getJSONPath(obj, path) {
        let split = path.split(".").reverse();
        let response = obj;
        while(split.length > 0) {
            response = response[split.pop()];
        }
        return response;
    }

    function changeInput(e) {
        let playerId = $(e.target).attr("id");
        let path = $(e.target).attr("attr");

        if($(e.target).attr("type") == "checkbox") {
            if($(e.target).is(":checked") == getJSONPath(pageData[playerId], path)) {
                delete changes[playerId + ";" + path];
            } else {
                changes[playerId + ";" + path] = $(e.target).is(":checked");
            }
        } else {
            if($(e.target).val() === getJSONPath(pageData[playerId], path)) {
                delete changes[playerId + ";" + path];
            } else {
                changes[playerId + ";" + path] = $(e.target).val();
            }
        }
    }

    function changeArea(e) {
        let playerId = $(e.target).attr("player");

        let competitionsString = ""
        pageData[playerId].competitions.forEach(c => {
            competitionsString += c.competition + ": " + c.placement + "\n";
        });

        if($(e.target).val() === competitionsString) {
            delete changes[playerId + ";competitions"]
        } else {
            let comps = []
            $(e.target).val().split("\n").forEach(c => {
                let comp = c.split(": ");
                if(comp.length > 1) {
                    comps.push({competition: comp[0], placement: comp[1]})
                }
            });
            changes[playerId + ";competitions"] = comps;
        }
    }

</script>