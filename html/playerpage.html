<!DOCTYPE html>
<html>
    <head>
        <title>RR Player Statistics</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css">
        <link rel="stylesheet" href="darkly.css">
    </head>
    <body>
        <div class="ui dimmer page active" id="dimmer">
            <div class="ui loader"></div>
        </div>
        <div class="ui relaxed centered grid">
            <div class="row">
                <div class="two wide column"><img class="ui large centered circular image" id="avatar"></div>
            </div>
            <div class="row">
                <div class="six wide column"><h1 class="ui center aligned header" id="name" style="font-weight: bold; font-size: 3rem;"></h1></div>
            </div>
            <div class="row">
                <div class="six wide column"><h2 class="ui center aligned header" id="title"></h2></div>
            </div>
            <div class="row">
                <div class="four wide column"><h3 class="ui center aligned header" style="font-style: italic;">Matches played: <span id="matchesPlayed" style="font-style: initial;"></span></h3></div>
                <div class="four wide column"><h3 class="ui center aligned header" style="font-style: italic;">Winrate: <span id="winrate" style="font-style: initial;"></span></h3></div>
            </div>
            <div class="row">
                <div class="seven wide column">
                    <table class="ui striped inverted structured table">
                        <thead><tr>
                            <td class="twelve wide" style="font-weight: bold;">Competition</td>
                            <td class="four wide" style="font-weight: bold;">Placement</td>
                        </tr>
                        <tr><td></td><td></td></tr></thead>
                        <tbody id="competitions">
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="2"><a id="competitionsLoadMore" startIndex=0 style="text-decoration: underline;"></a></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="seven wide column">
                    <table class="ui striped inverted structured table">
                        <thead><tr>
                            <td rowspan="2"></td>
                            <td rowspan="2"></td>
                            <td rowspan="2"></td>
                            <td style="font-weight: bold;">Player 1</td>
                            <td></td>
                            <td style="font-weight: bold;">Player 2</td>
                            <td colspan="5" style="font-weight: bold;">Maps</td>
                        </tr>
                        <tr>
                            <td colspan="3">
                                <input type="text" placeholder="Search for opponent" id="rivalSearch">
                            </td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr></thead>
                        <tbody id="matches">
                            
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="11"><a id="matchesLoadMore" startIndex=0 style="text-decoration: underline;"></a></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="row">
                <div class="seven wide column">
                    <table class="ui striped inverted sortable structured table">
                        <thead><tr>
                            <td class="twelve wide" style="font-weight: bold;">Map <span style="font-weight: unset;">(Only RR5)</span></td>
                            <td class="four wide" style="font-weight: bold;">Picked</td>
                        </tr></thead>
                        <tbody id="pickrate">
                        </tbody>
                    </table>
                </div>
                <div class="seven wide column">
                    <table class="ui striped inverted sortable structured table">
                        <thead><tr>
                            <td class="eleven wide" style="font-weight: bold;">Map</td>
                            <td class="three wide" style="font-weight: bold;">Winrate</td>
                            <td class="three wide" style="font-weight: bold;">Won/Played</td>
                        </tr></thead>
                        <tbody id="winrateTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div style="bottom: 5px; width: 100%; text-align: center; font-style: italic; position: relative; color: lightgray; margin-top: 10px;">Made with precision german engineering & calculated hungarian stats.</div>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.js"></script>
        <script src="utils.js"></script>

        <script>
            let pageData = {};

            $('#rivalSearch').on("input", () => {
                let all = $('tr', '#matches');
                let accepted = [];
                let notAccepted = [];
                all.each((idx, e) => {
                    if($(e).attr("rival").toLowerCase().search($('#rivalSearch').val().toLowerCase()) === -1) {
                        notAccepted.push(e);
                    } elseÂ {
                        accepted.push(e);
                    }
                });
                accepted.forEach(e => {$(e).fadeIn()});
                notAccepted.forEach(e => {$(e).fadeOut()});
            });

            function addMoreMatches() {
                const startIndex = parseInt($('#matchesLoadMore').attr("startIndex"));

                if(pageData.matches.length > startIndex + 5) {
                    pageData.matches.slice(startIndex, startIndex+5).forEach(e => {
                        addMatch(e);
                    });

                    if(pageData.matches.length - (startIndex + 5) > 5) {
                        $('#matchesLoadMore').text("Load 5 more matches...").attr("startIndex", startIndex+5);
                    } else {
                        $('#matchesLoadMore').text("Load " + (pageData.matches.length - (startIndex + 5)) + " more matches...").attr("startIndex", startIndex+5);
                    }
                } else {
                    pageData.matches.slice(startIndex).forEach(e => {
                        addMatch(e);
                    });
                    $('#matchesLoadMore').text("").attr("disabled", true);
                }
            }

            function addMatch(data) {
                const row = $("<tr></tr>");
                const localPlayer = (data.player1.replace(" [C]", "").replace(" [PC]", "").replace(" [PS]", "").replace(" [XB]", "") == pageData.name) ? 1 : 2;
                if(localPlayer == 1) {
                    row.attr("rival", data.player2);
                } else {
                    row.attr("rival", data.player1);
                }

                if($(row).attr("rival").toLowerCase().search($('#rivalSearch').val().toLowerCase()) === -1) {
                    row.hide(0);
                }

                if(data.maps.length <= 5) {
                    row.append($("<td></td>").text(data.competition));
                    row.append($("<td></td>").text(data.platform));
                    row.append($("<td></td>").text(data.round));
                    row.append($("<td></td>").text(data.player1));
                    row.append($("<td></td>").text(data.score));
                    row.append($("<td></td>").text(data.player2));
                    data.maps.forEach(element => {
                        if(element.winner == localPlayer) {
                            row.append($("<td></td>").text(element.map).addClass("positive"))
                        } else if(element.winner == 0) {
                            row.append($("<td></td>").text(element.map).addClass("warning"))
                        } else {
                            row.append($("<td></td>").text(element.map).addClass("negative"))
                        }
                    });

                    if(data.winner == localPlayer) {
                        row.addClass("positive");
                    } else {
                        row.addClass("negative");
                    }

                    $('#matches').append(row);
                } else {
                    row.append($("<td></td>").text(data.competition).attr("rowspan", "2"));
                    row.append($("<td></td>").text(data.platform).attr("rowspan", "2"));
                    row.append($("<td></td>").text(data.round).attr("rowspan", "2"));
                    row.append($("<td></td>").text(data.player1).attr("rowspan", "2"));
                    row.append($("<td></td>").text(data.score).attr("rowspan", "2"));
                    row.append($("<td></td>").text(data.player2).attr("rowspan", "2"));
                    data.maps.slice(0, 5).forEach(element => {
                        if(element.winner == localPlayer) {
                            row.append($("<td></td>").text(element.map).addClass("positive"))
                        } else if(element.winner == -1) {
                            row.append($("<td></td>").text(element.map).addClass("warning"))
                        } else {
                            row.append($("<td></td>").text(element.map).addClass("negative"))
                        }
                    });
                    if(data.winner == localPlayer) {
                        row.addClass("positive");
                    } else {
                        row.addClass("negative");
                    }
                    $('#matches').append(row);


                    const row2 = $('<tr></tr>');
                    if(localPlayer == 1) {
                        row2.attr("rival", data.player2);
                    } else {
                        row2.attr("rival", data.player1);
                    }

                    if($(row2).attr("rival").toLowerCase().search($('#rivalSearch').val().toLowerCase()) === -1) {
                        row.hide(0);
                    }

                    data.maps.slice(5).forEach(element => {
                        if(element.winner == localPlayer) {
                            row2.append($("<td></td>").text(element.map).addClass("positive"))
                        } else if(element.winner == -1) {
                            row2.append($("<td></td>").text(element.map).addClass("warning"))
                        } else {
                            row2.append($("<td></td>").text(element.map).addClass("negative"))
                        }
                    });
                    $('#matches').append(row2);
                }
            }

            function addMoreCompetitions() {
                const startIndex = parseInt($('#competitionsLoadMore').attr("startIndex"));

                if(pageData.competitions.length > startIndex + 5) {
                    pageData.competitions.slice(startIndex, startIndex+5).forEach(e => {
                        addCompetition(e);
                    });

                    if(pageData.competitions.length - (startIndex + 5) > 5) {
                        $('#competitionsLoadMore').text("Load 5 more competitions...").attr("startIndex", startIndex+5);
                    } else {
                        $('#competitionsLoadMore').text("Load " + (pageData.competitions.length - (startIndex + 5)) + " more competitions...").attr("startIndex", startIndex+5);
                    }
                } else {
                    pageData.competitions.slice(startIndex).forEach(e => {
                        addCompetition(e);
                    });
                    $('#competitionsLoadMore').text("").attr("disabled", true);
                }
            }

            function addCompetition(data) {
                const row = $('<tr></tr>').html("<td>" + data.competition + "</td><td>" + data.placement + "</td>");
                if(data.placement == "1st") {
                    row.addClass("positive");
                } else if(data.placement == "2nd") {
                    row.addClass("warning");
                } else if(data.placement == "3rd") {
                    row.addClass("negative");
                }
                $('#competitions').append(row);
            }

            function setPageContent(data) {
                pageData = data;

                $('#avatar').attr("src", data.avatar);
                $('#name').text(data.name);
                $('#title').text(data.title);

                // Calculate matches played & winrate
                $('#matchesPlayed').text(data.matches.length);
                let wonMatches = 0;
                data.matches.forEach(e => {
                    const localPlayer = (e.player1.replace(" [C]", "").replace(" [PC]", "").replace(" [PS]", "").replace(" [XB]", "") == data.name) ? 1 : 2;
                    if(e.winner == localPlayer) wonMatches++;
                });
                $('#winrate').text(Math.round((wonMatches / data.matches.length)*1000)/10 + "%");


                // Calculate map picks & wins
                let mapPicks = getDefaultMapPickObj();
                let mapWins = getDefaultMapWinObj();
                data.matches.forEach(e => {
                    const localPlayer = (e.player1.replace(" [C]", "").replace(" [PC]", "").replace(" [PS]", "").replace(" [XB]", "") == data.name) ? 1 : 2;
                    e.maps.forEach((map, idx) => {
                        let tmpPicks = mapPicks[mapAbreviationToArrayIndex(map.map)];
                        let tmpWins = mapWins[mapAbreviationToArrayIndex(map.map)];
                        // Only newest comp workaround
                        if(idx+1 == localPlayer && e.competition === "RR5") {
                            tmpPicks.picked += 1;
                        }
                        tmpWins.played += 1;
                        if(map.winner == localPlayer) {
                            tmpWins.won += 1;
                        }
                        mapWins[mapAbreviationToArrayIndex(map.map)] = tmpWins;
                        mapPicks[mapAbreviationToArrayIndex(map.map)] = tmpPicks;
                    });
                });

                //Display map picks & win
                mapPicks.filter(a => {
                    return a.picked > 0;
                }).sort((a, b) => {
                    return b.picked - a.picked;
                }).forEach(e => {
                    $('#pickrate').append($('<tr><td>' + mapAbreviationToFullName(e.map) + '</td><td>' + e.picked + '</td></tr>'));
                });

                mapWins.filter(a => {
                    return a.played > 0;
                }).sort((a, b) => {
                    return (b.won / b.played) - (a.won / a.played);
                }).forEach(e => {
                    $('#winrateTable').append($('<tr><td>' + mapAbreviationToFullName(e.map) + '</td><td>' + Math.round((e.won / e.played)*1000)/10 + '%</td><td>' + e.won + '/' + e.played + '</td></tr>'));
                });
                
                addMoreCompetitions();
                addMoreMatches();

                $('#dimmer').dimmer('hide');
            }

            $(document).ready(() => {
                $('#competitionsLoadMore').on("click", addMoreCompetitions);
                $('#matchesLoadMore').on("click", addMoreMatches);

                $('#dimmer').dimmer("set dimmed");
                $.getScript("api" + window.location.pathname, () => {});
             });
        </script>
    </body>
</html>