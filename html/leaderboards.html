<!DOCTYPE html>
<html>
    <head>
        <title>RR Player Statistics</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css">
        <link rel="stylesheet" href="darkly.css">
    </head>
    <body>
        <div class="ui container">
            <br>
            <h1 class="ui header" style="font-weight: bold; font-size: 3.2rem;">Leaderboards</h1>
            <br><br>
            <select class="ui selection dropdown" id="stat">
                <option value="" selected disabled>-- Select a statistic --</option>
                <option value="WR">Winrate</option>
                <option value="RRParticipations">Participations in Roulette Rivals Tournaments</option>
                <option value="RRWCParticipations">Participations in Roulette Rivals World Championships</option>
                <option value="Matches">Amount of matches</option>
                <option value="PercentageDecider">Percentage of matches with decider</option>
                <option value="DeciderWinrate">Winrate of decider maps</option>
                <option value="OwnMapWinrate">Winrate of own map-picks</option>
                <option value="OpponentMapWinrate">Winrate of opponent map-picks</option>
                <option value="LongestWinSpree">Longest winning-spree</option>
                <option value="MapPlayed">Amount of matches on one map</option>
                <option value="MapWR">Winrate on one map</option>
            </select>
            <select class="ui selection dropdown" id="map" style="display: none;">
                <option disabled>-- Season 1</option>
                <option value="PAR" selected>Paris</option>
                <option value="SAP">Sapienza</option>
                <option value="MAR">Marrakesh</option>
                <option value="BKK">Bangkok</option>
                <option value="COL">Colorado</option>
                <option value="HOK">Hokkaido</option>
                <option disabled>-- Season 2</option>
                <option value="MIA">Miami</option>
                <option value="SF">Santa Fortuna</option>
                <option value="MUM">Mumbai</option>
                <option value="WC">Whittleton Creek</option>
                <option value="SGA">Isle of Sgàil</option>
                <option value="NY">New York</option>
                <option value="HAV">Haven Island</option>
                <option disabled>-- Season 3</option>
                <option value="DUB">Dubai</option>
                <option value="DAR">Dartmoor</option>
                <option value="BER">Berlin</option>
                <option value="CHO">Chongqing</option>
                <option value="MEN">Mendoza</option>
            </select>
            <br><br>
            <table class="ui structured celled inverted table">
                <thead>
                    <tr>
                        <th>Placement</th>
                        <th>Player</th>
                        <th>Score</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th><input type="text" class="ui input" placeholder="Search for player" id="player"></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="ranking">
                </tbody>
            </table>
        </div>
        <div style="bottom: 5px; width: 100%; text-align: center; font-style: italic; position: relative; color: lightgray; margin-top: 10px;">Made with precision german engineering & calculated hungarian stats.</div>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.js"></script>
        <script src="utils.js"></script>
        <script>
            $('#player').on("input", () => {
                let all = $('tr', '#ranking');
                let accepted = [];
                let notAccepted = [];
                all.each((idx, e) => {
                    if($(e).attr("player").toLowerCase().search($('#player').val().toLowerCase()) === -1) {
                        notAccepted.push(e);
                    } else {
                        accepted.push(e);
                    }
                });
                accepted.forEach(e => {$(e).fadeIn()});
                notAccepted.forEach(e => {$(e).fadeOut()});
            });

            $('#stat').on("change", () => {
                if($('#stat').val() === "MapPlayed" || $('#stat').val() === "MapWR") {
                    $('#map').show();
                } else {
                    $('#map').hide();
                }
                updateTable();
            });

            $('#map').on("change", () => {
                updateTable();
            });

            let d;

            function updateTable() {
                $('#ranking').html("");
                let query = "/api/leaderboards?stat=" + $('#stat').val();
                if($('#stat').val() === "MapPlayed" || $('#stat').val() === "MapWR") {
                    query += "&map=" + $('#map').val();
                }
                $.getJSON(query, (data, success, x) => {
                    if(success === "success") {
                        d = data;
                        console.log(data);
                        data.order.forEach((e, idx) => {
                            let row = $('<tr></tr>').attr("player", e);
                            row.append($('<td></td>').text(idx+1 + "."));
                            row.append($('<td></td>').text(e));
                            let shouldAdd = true;
                            switch($('#stat').val()) {
                                case 'WR':
                                    row.append($("<td></td>").text(Math.floor((data.rankings[e].won/data.rankings[e].matches)*1000)/10 + "%"));
                                    if(data.rankings[e].matches == 0) shouldAdd = false;
                                    break;
                                case 'RRParticipations':
                                    row.append($("<td></td>").text(data.rankings[e].rrCompetitions.length));
                                    break;
                                case 'RRWCParticipations':
                                    row.append($("<td></td>").text(data.rankings[e].rrwcCompetitions.length));
                                    break;
                                case 'Matches':
                                    row.append($("<td></td>").text(data.rankings[e].matches));
                                    break;
                                case 'PercentageDecider':
                                    row.append($("<td></td>").text(Math.floor((data.rankings[e].matchesWithDecider/data.rankings[e].matchesWithoutGroups)*1000)/10 + "%"));
                                    if(data.rankings[e].matchesWithoutGroups == 0) shouldAdd = false;
                                    break;
                                case 'FinalAppearances':
                                    row.append($("<td></td>").text(data.rankings[e].grandFinalAppearances));
                                    break;
                                case 'LongestWinSpree':
                                    row.append($("<td></td>").text(data.rankings[e].longestWinningSpree));
                                    break;
                                case 'MapPlayed':
                                    row.append($("<td></td>").text(data.rankings[e].mapsPlayed[mapAbreviationToArrayIndex($('#map').val())]));
                                    break;
                                case 'MapWR':
                                    row.append($("<td></td>").text(Math.floor((data.rankings[e].mapsWon[mapAbreviationToArrayIndex($('#map').val())]/data.rankings[e].mapsPlayed[mapAbreviationToArrayIndex($('#map').val())])*1000)/10 + "%"));
                                    if(data.rankings[e].mapsPlayed[mapAbreviationToArrayIndex($('#map').val())] == 0) shouldAdd = false;
                                    break;
                                case "DeciderWinrate":
                                    row.append($("<td></td>").text(Math.floor((data.rankings[e].deciderWin/data.rankings[e].matchesWithDecider)*1000)/10 + "%"))
                                    if(data.rankings[e].matchesWithDecider == 0) shouldAdd = false;
                                    break;
                                case "OwnMapWinrate":
                                    row.append($("<td></td>").text(Math.floor((data.rankings[e].ownMapsWon/data.rankings[e].ownMaps)*1000)/10 + "%"));
                                    if(data.rankings[e].ownMaps == 0) shouldAdd = false;
                                    break;
                                case "OpponentMapWinrate":
                                    row.append($("<td></td>").text(Math.floor((data.rankings[e].opponentMapsWon/data.rankings[e].opponentMaps)*1000)/10 + "%"));
                                    if(data.rankings[e].opponentMaps == 0) shouldAdd = false;
                                    break;
                            }
                            if(shouldAdd) $('#ranking').append(row);
                        })
                    }
                })
            }
        </script>
    </body>
</html>